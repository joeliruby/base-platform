<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.matariky.userservice.mapper.PermissionMapper" >
  <resultMap id="BaseResultMap" type="com.matariky.userservice.bean.Permission" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="parent_id" property="parentId" jdbcType="BIGINT" />
    <result column="permission_name" property="permissionName" jdbcType="VARCHAR" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="tenant_id" property="tenantId" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="BIGINT" />
    <result column="update_time" property="updateTime" jdbcType="BIGINT" />
    <result column="delete_time" property="deleteTime" jdbcType="BIGINT" />
    <result column="application_id" property="applicationId" jdbcType="BIGINT" />
    <result column="resource_type" property="resourceType" jdbcType="INTEGER" />
    <result column="icon" property="icon" jdbcType="VARCHAR" />
    <result column="is_active" property="isActive" jdbcType="BIT" />
    <result column="sort_order" property="sortOrder" jdbcType="BIGINT" />
    <result column="url" property="url" jdbcType="VARCHAR" />
    <result column="created_by" property="createdBy" jdbcType="BIGINT" />
    <result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
    <result column="access_type" property="accessType" jdbcType="INTEGER" />
    <result column="resource_attribute" property="resourceAttribute" jdbcType="INTEGER" />
    <result column="orig_id" property="origId" jdbcType="BIGINT" />
    <result column="in_suite" property="inSuite" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    id, parent_id, permission_name, description, tenant_id, create_time, update_time,
    delete_time, application_id, resource_type, icon, is_active, sort_order, url, created_by,
    updated_by, access_type, resource_attribute, orig_id, in_suite
  </sql>
  <select id="getPermissionsById"  parameterType="String" resultType="com.matariky.userservice.dto.PermissionInfoVO" >
        SELECT
            u.id,
            u.parent_id,
            (SELECT p.permission_name from   user_permission  p where p.id = u.parent_id  ) parentPermissionName,
            u.permission_name,
            u.description,
            u.tenant_id,
            u.create_time,
            u.update_time,
            u.delete_time,
            u.application_id,
            u.resource_type,
            u.icon,
            u.is_active,
            u.sort_order,
            u.url,
            u.created_by,
            u.updated_by,
            u.access_type,
            u.resource_attribute,
            u.in_suite
        FROM
            user_permission   u
        WHERE
            u.id = #{value}
	</select>
  <update id="updatePermission" parameterType="com.matariky.userservice.bean.Permission">
        update user_organization
         set id=#{params.id}
    <if test="params.parentId != null ">
        	,parent_id=#{params.parentId}
        </if>
    <if test="params.permissionName != null ">
			        	,permission_name=#{params.permissionName}
			        </if>
    <if test="params.description != null ">
			        	,description=#{params.description}
			        </if>
    <if test="params.tenantId != null ">
			        	,tenant_id=#{params.tenantId}
			        </if>
    <if test="params.createTime != null ">
			        	,create_time=#{params.createTime}
			        </if>
    <if test="params.updateTime != null ">
			        	,update_time=#{params.updateTime}
			        </if>
    <if test="params.deleteTime != null ">
			        	,delete_time=#{params.deleteTime}
			        </if>
    <if test="params.applicationId != null ">
			        	,application_id=#{params.applicationId}
			        </if>
    <if test="params.resourceType != null ">
			        	,resource_type=#{params.resourceType}
			        </if>
    <if test="params.icon != null ">
			        	,icon=#{params.icon}
			        </if>
    <if test="params.isActive != null ">
			        	,is_active=#{params.isActive}
			        </if>
    <if test="params.sortOrder != null ">
			        	,sort_order=#{params.sortOrder}
			        </if>
    <if test="params.url != null ">
			        	,url=#{params.url}
			        </if>
    <if test="params.createdBy != null ">
			        	,created_by=#{params.createdBy}
			        </if>
    <if test="params.updatedBy != null ">
			        	,updated_by=#{params.updatedBy}
			        </if>
    <if test="params.accessType != null ">
			        	,access_type=#{params.accessType}
			        </if>
    <if test="params.resourceAttribute != null ">
			        	,resource_attribute=#{params.resourceAttribute}
			        </if>
    <if test="params.alias != null ">
			        	,alias=#{params.alias}
			        </if>
    <if test="params.origId != null ">
			        	,orig_id=#{params.origId}
			        </if>
    <if test="params.inSuite != null ">
			        	,in_suite=#{params.inSuite}
			        </if>

        where id = #{params.id} and delete_time=0
  </update>
  <update id="updateDeleteTimeById">
    	update user_permission
    <set >
        	delete_time = unix_timestamp()
    	</set>
    	where id in
    <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
  </update>
  <select id="getAllMenuList" parameterType="Map" resultType="com.matariky.userservice.bean.TreeModel">
		SELECT
			p.id,
			p.parent_id AS pid,
			p.permission_name AS NAME,
			a.application_name AS applicationName,
			resource_type AS resourceType,
			p.icon,
			p.is_active AS isActive,
			p.sort_order AS sortOrder,
			p.url
		FROM
			user_permission p
			LEFT JOIN user_application a ON p.application_id = a.id
		where p.delete_time=0 and p.is_active=1 and a.delete_time=0 and a.is_active=1
    <if test="params.tenantId != null and params.tenantId !=''">
            AND  p.tenant_id= #{params.tenantId}
        </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    select
    <include refid="Base_Column_List" />
    from user_permission
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    delete from user_permission
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.matariky.userservice.bean.Permission" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    insert into user_permission (id, parent_id, permission_name,
      description, tenant_id, create_time,
      update_time, delete_time, application_id,
      resource_type, icon, is_active,
      sort_order, url, created_by,
      updated_by, access_type, resource_attribute, in_suite
      )
    values (#{id,jdbcType=BIGINT}, #{parentId,jdbcType=BIGINT}, #{permissionName,jdbcType=VARCHAR},
      #{description,jdbcType=VARCHAR}, #{tenantId,jdbcType=VARCHAR}, #{createTime,jdbcType=BIGINT},
      #{updateTime,jdbcType=BIGINT}, #{deleteTime,jdbcType=BIGINT}, #{applicationId,jdbcType=BIGINT},
      #{resourceType,jdbcType=INTEGER}, #{icon,jdbcType=VARCHAR}, #{isActive,jdbcType=BIT},
      #{sortOrder,jdbcType=BIGINT}, #{url,jdbcType=VARCHAR}, #{createdBy,jdbcType=BIGINT},
      #{updatedBy,jdbcType=BIGINT}, #{accessType,jdbcType=INTEGER}, #{resourceAttribute,jdbcType=INTEGER},
      #{inSuite,jdbcType=BIGINT}
      )
  </insert>
  <insert id="createPermission" parameterType="com.matariky.userservice.bean.Permission" >
  	insert into user_permission ( parent_id, permission_name,
      description, tenant_id, create_time,
      update_time, delete_time, application_id,
      resource_type, icon, is_active,
      sort_order, url, created_by,
      updated_by, access_type, resource_attribute, in_suite
      )
    values ( #{parentId,jdbcType=BIGINT}, #{permissionName,jdbcType=VARCHAR},
      #{description,jdbcType=VARCHAR}, #{tenantId,jdbcType=VARCHAR}, #{createTime,jdbcType=BIGINT},
      #{updateTime,jdbcType=BIGINT}, #{deleteTime,jdbcType=BIGINT}, #{applicationId,jdbcType=BIGINT},
      #{resourceType,jdbcType=INTEGER}, #{icon,jdbcType=VARCHAR}, #{isActive,jdbcType=BIT},
      #{sortOrder,jdbcType=BIGINT}, #{url,jdbcType=VARCHAR}, #{createdBy,jdbcType=BIGINT},
      #{updatedBy,jdbcType=BIGINT}, #{accessType,jdbcType=INTEGER}, #{resourceAttribute,jdbcType=INTEGER},
      #{inSuite,jdbcType=BIGINT}
      )
    <selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
         SELECT LAST_INSERT_ID();
     </selectKey>
  </insert>
  <insert id="insertSelective" parameterType="com.matariky.userservice.bean.Permission" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    insert into user_permission
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="parentId != null" >
        parent_id,
      </if>
      <if test="permissionName != null" >
        permission_name,
      </if>
      <if test="description != null" >
        description,
      </if>
      <if test="tenantId != null" >
        tenant_id,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="deleteTime != null" >
        delete_time,
      </if>
      <if test="applicationId != null" >
        application_id,
      </if>
      <if test="resourceType != null" >
        resource_type,
      </if>
      <if test="icon != null" >
        icon,
      </if>
      <if test="isActive != null" >
        is_active,
      </if>
      <if test="sortOrder != null" >
        sort_order,
      </if>
      <if test="url != null" >
        url,
      </if>
      <if test="createdBy != null" >
        created_by,
      </if>
      <if test="updatedBy != null" >
        updated_by,
      </if>
      <if test="accessType != null" >
        access_type,
      </if>
      <if test="resourceAttribute != null" >
        resource_attribute,
      </if>
      <if test="inSuite != null" >
            in_suite,
        </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="parentId != null" >
        #{parentId,jdbcType=BIGINT},
      </if>
      <if test="permissionName != null" >
        #{permissionName,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="tenantId != null" >
        #{tenantId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=BIGINT},
      </if>
      <if test="deleteTime != null" >
        #{deleteTime,jdbcType=BIGINT},
      </if>
      <if test="applicationId != null" >
        #{applicationId,jdbcType=BIGINT},
      </if>
      <if test="resourceType != null" >
        #{resourceType,jdbcType=INTEGER},
      </if>
      <if test="icon != null" >
        #{icon,jdbcType=VARCHAR},
      </if>
      <if test="isActive != null" >
        #{isActive,jdbcType=BIT},
      </if>
      <if test="sortOrder != null" >
        #{sortOrder,jdbcType=INTEGER},
      </if>
      <if test="url != null" >
        #{url,jdbcType=VARCHAR},
      </if>
      <if test="createdBy != null" >
        #{createdBy,jdbcType=BIGINT},
      </if>
      <if test="updatedBy != null" >
        #{updatedBy,jdbcType=BIGINT},
      </if>
      <if test="accessType != null" >
        #{accessType,jdbcType=INTEGER},
      </if>
      <if test="resourceAttribute != null" >
        #{resourceAttribute,jdbcType=INTEGER},
      </if>
      <if test="inSuite != null" >
            #{inSuite,jdbcType=BIGINT},
        </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.matariky.userservice.bean.Permission" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    update user_permission
    <set >
      <if test="parentId != null" >
        parent_id = #{parentId,jdbcType=BIGINT},
      </if>
      <if test="permissionName != null" >
        permission_name = #{permissionName,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="tenantId != null" >
        tenant_id = #{tenantId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=BIGINT},
      </if>
      <if test="deleteTime != null" >
        delete_time = #{deleteTime,jdbcType=BIGINT},
      </if>
      <if test="applicationId != null" >
        application_id = #{applicationId,jdbcType=BIGINT},
      </if>
      <if test="resourceType != null" >
        resource_type = #{resourceType,jdbcType=INTEGER},
      </if>
      <if test="icon != null" >
        icon = #{icon,jdbcType=VARCHAR},
      </if>
      <if test="isActive != null" >
        is_active = #{isActive,jdbcType=BIT},
      </if>
      <if test="sortOrder != null" >
        sort_order = #{sortOrder,jdbcType=BIGINT},
      </if>
      <if test="url != null" >
        url = #{url,jdbcType=VARCHAR},
      </if>
      <if test="createdBy != null" >
        created_by = #{createdBy,jdbcType=BIGINT},
      </if>
      <if test="updatedBy != null" >
        updated_by = #{updatedBy,jdbcType=BIGINT},
      </if>
      <if test="accessType != null" >
        access_type = #{accessType,jdbcType=INTEGER},
      </if>
      <if test="resourceAttribute != null" >
        resource_attribute = #{resourceAttribute,jdbcType=INTEGER},
      </if>
      <if test="inSuite != null" >
            in_suite = #{inSuite,jdbcType=BIGINT},
        </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.matariky.userservice.bean.Permission" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 09 11:28:38 CST 2020.
    -->
    update user_permission
    set parent_id = #{parentId,jdbcType=BIGINT},
      permission_name = #{permissionName,jdbcType=VARCHAR},
      description = #{description,jdbcType=VARCHAR},
      tenant_id = #{tenantId,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=BIGINT},
      update_time = #{updateTime,jdbcType=BIGINT},
      delete_time = #{deleteTime,jdbcType=BIGINT},
      application_id = #{applicationId,jdbcType=BIGINT},
      resource_type = #{resourceType,jdbcType=INTEGER},
      icon = #{icon,jdbcType=VARCHAR},
      is_active = #{isActive,jdbcType=BIT},
      sort_order = #{sortOrder,jdbcType=BIGINT},
      url = #{url,jdbcType=VARCHAR},
      created_by = #{createdBy,jdbcType=BIGINT},
      updated_by = #{updatedBy,jdbcType=BIGINT},
      access_type = #{accessType,jdbcType=INTEGER},
      resource_attribute = #{resourceAttribute,jdbcType=INTEGER},
      in_suite = #{inSuite,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="getPermissionByTenantId" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Sep 03 09:36:16 CST 2020.
    -->
    select
    <include refid="Base_Column_List" />
    from user_permission
    where tenant_id = #{tenantId,jdbcType=BIGINT}
  </select>
  <select id="getPermissionTreeByTenantId" resultType="com.matariky.userservice.bean.TreeModel">
	    SELECT
			id,
			parent_id AS pid,
			permission_name AS NAME,
            in_suite AS inSuite
		FROM
			user_permission
		WHERE
			delete_time = 0
		AND is_active = 1
		AND application_id = #{applicationId}
		AND tenant_id =#{tenantId}
    <if test="inSuiteVaild != null">
            AND in_suite in (1,2)
        </if>
        
        order by id asc
  </select>
  <select id="getPermissionList" resultType="com.matariky.userservice.dto.PermissionDTO">
		SELECT
		id, parent_id AS pid, permission_name, description, tenant_id, create_time, update_time,
    	delete_time, application_id, resource_type, icon, is_active, order_num, url, created_by,
    	updated_by, access_type, resource_attribute
		FROM
			user_permission t1
		LEFT JOIN user_r_user_permission t2 ON t1.id = t2.permission_id
    <where>
      <if test="userId!= null">
			t2.user_id =#{userId}
			</if>
      <if test="tenantId!= null">
			and t1.tenant_id =#{tenantId}
			</if>
    </where>
  </select>
  <select id="getTreeByApplicationId"  resultType="com.matariky.userservice.bean.TreeModel">
     	SELECT
			p.id,
			p.parent_id AS pid,
			p.permission_name AS NAME
		FROM
			user_permission p , user_r_user_permission r
    <where>
			p.tenant_id =#{tenantId ,jdbcType=VARCHAR}
		AND p.application_id = #{applicationId,jdbcType=BIGINT}
		AND p.is_active = 1 and p.delete_time=0
		AND r.permission_id = p.id
      <if test="userId!=null and userId!='' ">
            AND r.user_id=#{userId,jdbcType=BIGINT}
        </if>
    </where>
  </select>
  <select id="selectByTenantIdAndPermissionName" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Sep 03 09:36:16 CST 2020.
    -->
    select
    <include refid="Base_Column_List" />
    from user_permission
    where tenant_id = #{tenantId,jdbcType=VARCHAR} and permission_name =#{permissionName,jdbcType=VARCHAR} and delete_time=0
  </select>
  <select id="getOrderSuitePermissionByParam" parameterType="java.util.Map"  resultMap="BaseResultMap">
        SELECT
            p.*
        FROM
            
            user_permission AS p
           
        WHERE
          p.delete_time=0
    <if test="params.resourceType != null">
          AND p.resource_type = #{params.resourceType}
            </if>
    <if test="params.permissionName != null">
            AND p.permission_name like concat('%', #{params.permissionName}, '%')
        </if>
    <if test="params.applicationId != null">
            AND p.application_id = #{params.applicationId}
        </if>
  </select>
  <select id="getOrderSuitePermissionByUserId" parameterType="java.util.Map"  resultMap="BaseResultMap">
        SELECT
            p.*
        FROM
            order_suite_permission AS osp,
            user_permission AS p,
            (
                SELECT DISTINCT
                    o.suite_code
                FROM
                    order_info AS o
                WHERE
                o.delete_time = 0
    <if test="params.orderTenantId != null">
                    AND o.order_tenant_id = #{params.orderTenantId}
                  </if>
                  AND o.order_status = 1
            ) AS a
        WHERE
            a.suite_code = osp.suite_code
          AND osp.permission_id = p.id
  </select>
  <select id="selectPermissionByTenantId" parameterType="java.util.Map"  resultMap="BaseResultMap">
        SELECT
            p.*
        FROM
            order_info AS o,
            order_suite_permission AS osp,
            user_permission AS p
        WHERE
            o.suite_code = osp.suite_code
          AND p.id = osp.permission_id
          AND o.delete_time = 0
          AND o.order_status = 1
          AND p.delete_time = 0
          AND o.order_tenant_id = #{params.orderTenantId}
    </select>
</mapper>